name: Run pipeline

on:
  workflow_dispatch:
    inputs:
      season:
        description: "Season tag (e.g., 2025)"
        required: true
        default: "2025"

      # Strict mode input (NEW)
      strict:
        description: "Strict mode (0 = tolerant, 1 = strict)"
        required: false
        default: "0"

      # Odds controls (NEW)
      odds_date:
        description: "Only fetch lines for this calendar day (YYYY-MM-DD, optional)"
        required: false
        default: ""
      odds_from:
        description: "Commence time >= (ISO-8601, optional)"
        required: false
        default: ""
      odds_to:
        description: "Commence time < (ISO-8601, optional)"
        required: false
        default: ""
      odds_markets:
        description: "Markets to include (comma-separated). Leave BLANK to fetch ALL markets (game lines + ALL player props incl. anytime TD)."
        required: false
        default: "spreads,totals,ml"
      all_markets:
        description: "Fetch ALL markets (overrides 'markets')"
        type: boolean
        required: false
        default: true
      odds_books:
        description: "Bookmakers to include (comma-separated keys)"
        required: false
        default: "draftkings,fanduel,betmgm,caesars"
      odds_props_only:
        description: "Only fetch props (true/false)"
        required: false
        default: "false"
      odds_sides_only:
        description: "Only fetch sides/totals/ml (true/false)"
        required: false
        default: "false"
      odds_cap:
        description: "Hard cap on number of events to fetch (0 = no cap)"
        required: false
        default: "0"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # Plumb season/strict across steps
      SEASON: ${{ github.event.inputs.season }}
      STRICT: ${{ github.event.inputs.strict }}

      # Make secrets visible to Python fetchers (fallback providers)
      MSF_KEY:        ${{ secrets.MSF_KEY }}
      MSF_PASSWORD:   ${{ secrets.MSF_PASSWORD }}
      APISPORTS_KEY:  ${{ secrets.APISPORTS_KEY }}
      NFLGSIS_USERNAME: ${{ secrets.NFLGSIS_USERNAME }}
      NFLGSIS_PASSWORD: ${{ secrets.NFLGSIS_PASSWORD }}
      THE_ODDS_API_KEY: ${{ secrets.THE_ODDS_API_KEY }}
  
      # ðŸŽ¯ Odds Filtering Inputs (optional)
      ODDS_DATE:        ${{ github.event.inputs.odds_date }}
      ODDS_FROM:        ${{ github.event.inputs.odds_from }}
      ODDS_TO:          ${{ github.event.inputs.odds_to }}
      ODDS_MARKETS:     ${{ github.event.inputs.odds_markets }}
      ODDS_BOOKS:       ${{ github.event.inputs.odds_books }}
      ODDS_PROPS_ONLY:  ${{ github.event.inputs.odds_props_only }}
      ODDS_SIDES_ONLY:  ${{ github.event.inputs.odds_sides_only }}
      ODDS_CAP:         ${{ github.event.inputs.odds_cap }}
      ODDS_ALL_MARKETS: ${{ github.event.inputs.all_markets }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "Repo root: $PWD"
          ls -la
          if [ -f requirements-extended.txt ]; then
            pip install -r requirements-extended.txt
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "::warning::No requirements*.txt found; proceeding with installed environment."
          fi
          python -V
          pip -V

      - name: Show layout (debug)
        shell: bash
        run: |
          set -euo pipefail
          echo "== tree -L 3 =="
          (command -v tree >/dev/null 2>&1 && tree -L 3 || ls -R | sed -n '1,300p') || true

      # -----------------------------
      # FETCH RAW (multi-source)
      # -----------------------------
      - name: Fetch free data (nflverse + fallbacks)
        shell: bash
        run: |
          set -euo pipefail
          echo "[fetch_all] season=${SEASON}"
          if [ -f external/nflverse_bundle/fetch_all.py ]; then
            python external/nflverse_bundle/fetch_all.py --season "${SEASON}"
          else
            echo "::warning::external/nflverse_bundle/fetch_all.py not found; skipping raw fetch step."
          fi

      # -----------------------------
      # RUN ADDONS (optional)
      # -----------------------------
      - name: Run addons (if present)
        shell: bash
        run: |
          set -euo pipefail
          runp() { [ -f "$1" ] && echo ">> $1" && python "$1" --season "${SEASON}" || echo "skip $1"; }
          runp external/nflverse_bundle/addons/derive_proe.py
          runp external/nflverse_bundle/addons/aggregate_box_counts.py
          runp external/nflverse_bundle/addons/derive_roles.py
          runp external/nflverse_bundle/addons/derive_rb_metrics.py
          runp external/nflverse_bundle/addons/fetch_injuries_espn.py
          runp external/nflverse_bundle/addons/fetch_odds.py

      # -----------------------------
      # COMPOSE (call whichever make_all exists)
      # -----------------------------
      - name: Compose bundle (team_form / player_form)
        shell: bash
        run: |
          set -euo pipefail
          SEASON="${{ github.event.inputs.season }}"
          STRICT="${{ github.event.inputs.strict }}"
          STRICT_FLAG=""
          if [ -n "${STRICT}" ]; then STRICT_FLAG="--strict ${STRICT}"; fi

          python external/nflverse_bundle/make_all.py --season "${SEASON}" ${STRICT_FLAG}


          if [ -f external/nflverse_bundle/make_all.py ]; then
            echo "Found: external/nflverse_bundle/make_all.py"
            python external/nflverse_bundle/make_all.py --season "${SEASON}" --strict "${STRICT}"
          else
            echo "::error ::make_all.py not found"; exit 1
          fi

      # -----------------------------
      # VALIDATE OUTPUTS (optional)
      # -----------------------------
      - name: Validate data pack outputs
        shell: bash
        run: |
          set -euo pipefail
          if [ -f scripts/validate_inputs.py ]; then
            python scripts/validate_inputs.py
          else
            echo "::warning::No validator found at scripts/validate_inputs.py; skipping validation."
          fi

      - name: Run predictive model (if script exists)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f run_model.py ]; then
            echo "Found run_model.py â€” executing..."
            python run_model.py --season "${SEASON}" --strict "${STRICT}"
          else
            echo "::warning::run_model.py not found â€” skipping model execution."
          fi

      # -----------------------------
      # ZIP OUTPUTS (artifact)
      # -----------------------------
      - name: Pack outputs artifact
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _artifacts
          (tar -czf _artifacts/outputs.tgz outputs || true)
          (tar -czf _artifacts/data.tgz data || true)
          (tar -czf _artifacts/external-outputs.tgz external/nflverse_bundle/outputs || true)

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-pack-${{ github.run_id }}
          path: _artifacts
          if-no-files-found: warn
